#!/system/bin/sh

umask 077

# DEBUG=1

# Files for authentication
RSA_KEY=/data/ssh/ssh_host_rsa_key
RSA_PUB_KEY=/data/ssh/ssh_host_rsa_key.pub
ED25519_KEY=/data/ssh/ssh_host_ed25519_key
ED25519_PUB_KEY=/data/ssh/ssh_host_ed25519_key.pub
ECDSA_KEY=/data/ssh/ssh_host_ecdsa_key
ECDSA_PUB_KEY=/data/ssh/ssh_host_ecdsa_key.pub
AUTHORIZED_KEYS=/data/ssh/authorized_keys

# Configuration file (for location see Android.bp)
SSHD_CONFIG=/system/etc/ssh/sshd_config

if [ ! -f $RSA_KEY ]; then
    # $RSA_KEY doesn't exists. Generate a new rsa key which will be used as HostKey (see sshd_config).
    /system/bin/ssh-keygen -t rsa -f $RSA_KEY -N ""
    chmod 600 /$RSA_KEY
    chmod 644 $RSA_PUB_KEY
fi

if [ ! -f $ECDSA_KEY ]; then
    # $ECDSA_KEY doesn't exists. Generate a new ecdsa key which will be used as HostKey (see sshd_config).
    /system/bin/ssh-keygen -t ecdsa -f $ECDSA_KEY -N ""
    chmod 600 /$ECDSA_KEY
    chmod 644 $ECDSA_PUB_KEY
fi

if [ ! -f $ED25519_KEY ]; then
    # $ED25519_KEY doesn't exists. Generate a new ed25519 key which will be used for authorization.
    /system/bin/ssh-keygen -t ed25519 -f $ED25519_KEY -N ""
    chmod 600 /$ED25519_KEY
    chmod 644 $ED25519_PUB_KEY
fi

if [[ ! -f $AUTHORIZED_KEYS ]]; then
    # $AUTHORIZED_KEYS doesn't exists. Copy the content of $ED25519_PUB_KEY into it.
    cat $ED25519_PUB_KEY > $AUTHORIZED_KEYS
fi

if [ "1" == "$DEBUG" ] ; then
        # run sshd in debug mode and capture output to logcat
        /system/bin/logwrapper /system/bin/sshd -f "$SSHD_CONFIG" -D -d
else
        # don't daemonize - otherwise we can't stop the sshd service
        /system/bin/sshd -f "$SSHD_CONFIG" -D
fi